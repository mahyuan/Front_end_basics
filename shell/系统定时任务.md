# 定时任务

## at 一次性定时任务
at服务是否安装
> chkconfig --list | grep atd

at服务重启
> service atd restart

at的访问控制
> /etc/at.allow 白名单
> /etc/at.deny 黑名单 （对root不起作用）

白名单比黑名单优先级高。
如果这两个文件都不存在，那么只有root用户可以使用at命令

at使用方法:
> at [选项] 时间

选项：
 - -m: 当at工作完成后，无论是否命令有输出，都用email通知执行at命令的用户
 - -c：工作号：显示该at工作的实际内容

时间：
HH:MM  03:23
HH:MM: YYYY-MM=DD 02:32 2018-09-21
...

eg:
```sh
#在2分钟后执行脚本hello.sh
at now +2 minutes 
at > /home/mhy/work/hello.sh >> /home/mhy/work/log_hello.log
```

> atq #查询当前服务器上的at工作、

> atrm [工作号] # 删除指定的at任务

## crontab 循环定时任务
查看crond服务是否在运行：
```sh
chkconfig --list | grep cron
```
```sh
service crond status
```
启动crond服务：
```sh
service crond start|restart
```

> crontab [选项] (参数)

选项：
 - -e: 编辑当前用户crontab定时任务
 - -l: 查询当前用户crontab定时任务
 - -r: 删除当前用户所有的crontab定时任务
 - -u<用户名>: 指定要设定时任务的用户名称 

参数：
 - crontab文件： 指定包含待执行任务的crontab文件


绑定当前登录用户，要确保没有超出当前用户权限。

linux下的任务调度分为两类：系统任务调度和用户任务调度。

### 系统任务调度
系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。在`/etc`目录下有个crontab文件，这个就是系统任务调度的配置文件。
`/etc/crontab`默认有以下内容：
```sh
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
```
前四行是用来配置crond任务运行的环境变量，第一行SHELL变量指定了系统要使用哪个shell，这里是bash，第二行PATH变量指定了系统执行命令的路径，第三行MAILTO变量指定了crond的任务执行信息将通过电子邮件发送给root用户，如果MAILTO变量的值为空，则表示不发送任务执行信息给用户，第四行的HOME变量指定了在执行命令或者脚本时使用的主目录。

### 用户任务调度
用户定期执行的工作，比如数据备份、定时邮件提醒等。 用户可以使用crontab工具来定制自己的计划任务。所有永不定义crontab文件都保存在`/var/spool/cron`目录中。其文件名与用户名一致，使用者权限文件如下：
```
/etc/cron.deny 该文件中所有用户不允许使用crontab命令（黑名单）
/etc/cron.allow 该文件中所列用户允许使用crontab命令 （白名单）
/etc/spool/cron/ 所有用户crontab文件存放的目录，以用户名命名
```
**白名单比黑名单优先级高**， 白名单的用户一定有权限，黑名单的用户如果在白名单，则有权限；如果黑名单的用户不在白名单，则没有权限。
所以只需要把需要限制权限的用户加入到黑名单就可以了，白名单不需要单独添加用户，除了优先级外，有权限的用户一般都比限制权限的用户多，加黑名单比较方便。

### crontab文件的含义
用户所建立的crontab文件中，每一行都代表一条任务，每行的每个字段代表一项设置，它的格式一共分为六个字段，前五段是时间设定段，第六段是要执行的命令段，格式如下：
```sh
* * * * * [执行的任务]
```
顺序： `miniute hour day month week command`
其中：
- minute:  一小时当中的第几分钟, 范围0-59之间的任意整数
- hour: 一天当中的第几个小时, 范围是0-23之间的任意整数
- day: 一个月当中的第几天, 范围是1-31之间的任意整数
- month: 一年当中的第几个月, 范围是1-12之间的任意整数
- week: 一周当中的星期几, 范围是0-7(0和7都代表星期日)之间的任意整数
- command: 要执行的命令，可以是系统命令，也可以是自己编写的脚本文件

以上各个字段中， 还可以使用以下特殊字符：
- 星号`*`: 代表所有可能的值，比如minute字段为`*`代表每分钟执行一次
- 逗号`,`: 逗号隔开的值指定一个列表范围，比如: `1,2,3,5,6`,列表中的每个时间点执行一次
- 中杠`-`: 可以用整数之间的中杠表示一个整数范围，如：`2-5`表示`2,3,4,5`
- 正斜线`/`: 正斜线指定时间的间隔频率， 如`0-23/2`表示每两个小时执行一次，minute字段的`*/10`表示每十分钟执行一次





**使用以下命令设置定时任务:**
```sh
crontab -e
#进入crontab编辑界面。会打开vim编辑，按刚才的格式设置定时任务
```

crontab定时任务实例：
```sh



```



> crontab -l # 查询crontab任务

> crontab -r # 清除当前用户的所有crontab任务

注意事项：
- 六个选项都不能为空，必须填写，如果不确定使，用`*`代替任意时间
- crontab定时任务，最小有效时间是分钟，最大时间范围是月
- 在定义时间时，日期和星期最好不要在一条定时任务中出现，因为他们都是以天为单位，不利于管理员管理
- 在定时任务中，不管是直接写命令，还是在脚本中写命令，最好都用绝对路径

